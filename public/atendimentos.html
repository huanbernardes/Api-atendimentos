<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Atendimentos Simples</title>
 <style>
  body, html {
  font-family: Arial;
  background-color: #f4f6f8;
  margin: 0;
  padding: 0;
  height: auto;
  overflow-y: auto;
}

.container {
  max-width: 600px;
  margin: 40px auto;
  background: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

input, select, button {
  width: 100%;
  margin: 5px 0;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  box-sizing: border-box;
}

button {
  width: auto;
  background-color: #007bff;
  color: white;
  font-weight: bold;
  border: none;
  cursor: pointer;
  margin-right: 5px;
  padding: 10px 15px;
  border-radius: 6px;
}

button:hover {
  background-color: #0056b3;
}

.card {
  border: 1px solid #ccc;
  padding: 15px;
  margin-top: 10px;
  border-radius: 8px;
  background: #fafafa;
}

.card strong {
  display: block;
  font-size: 1.1em;
  margin-bottom: 5px;
}

#lista {
  margin-top: 20px;
  overflow: visible;
}

</style>

  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <div class="container">
    <h1>Atendimentos</h1>
    <h2>Página de Atendimentos</h2>

    <input type="text" id="servico" placeholder="Serviço" />
    <input type="text" id="cliente" placeholder="Cliente" />
    <input type="date" id="data" />
    <select id="status">
      <option value="Ativo">Ativo</option>
      <option value="Finalizado">Finalizado</option>
      <option value="Cancelado">Cancelado</option>
    </select>

    <button onclick="adicionar()">Adicionar</button>

    <div id="lista"></div>

    <div id="adminArea" class="admin-info"></div>

    <button class="logout-btn" onclick="logout()">Sair</button>
  </div>

  <script>
    const api = 'http://localhost:3000/api/atendimentos';

    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    }

    // Verifica se é admin
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      if (payload.is_admin) {
        document.getElementById('adminArea').innerHTML = 'Você é ADMINISTRADOR';
      }
    } catch (e) {
      alert('Token inválido');
      logout();
    }

    function logout() {
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    }

   function carregar() {
  fetch(api, {
    headers: {
      'Authorization': 'Bearer ' + token
    }
  })
    .then(res => {
      if (!res.ok) throw new Error(`Erro ${res.status}`);
      return res.json();
    })
    .then(dados => {
      console.log('Dados recebidos:', dados);
      const lista = document.getElementById('lista');
      lista.innerHTML = '';
      dados.forEach(a => {
  // Formata a data corretamente usando a.data_atendimento
  const dataFormatada = a.data_atendimento ? new Date(a.data_atendimento).toLocaleDateString() : 'Data inválida';

  // Para editar, usa o formato yyyy-mm-dd, substring é mais seguro que split
  const dataParaEditar = a.data_atendimento ? a.data_atendimento.substring(0, 10) : '';

  const div = document.createElement('div');
  
  div.className = 'card';
  div.innerHTML = `
    <strong>${a.servico}</strong><br>
    Cliente: ${a.cliente}<br>
    Data: ${dataFormatada}<br>
    Status: ${a.status}<br>
    <button onclick="editar(${a.id}, '${a.servico}', '${a.cliente}', '${dataParaEditar}', '${a.status}')">Editar</button>
    <button onclick="excluir(${a.id})">Excluir</button>
  `;
  lista.appendChild(div);
});

    })
    .catch(err => {
      alert('Erro ao carregar atendimentos: ' + err.message);
      console.error(err);
    });
}


    function adicionar() {
      const servico = document.getElementById('servico').value.trim();
      const cliente = document.getElementById('cliente').value.trim();
      const data = document.getElementById('data').value;
      const status = document.getElementById('status').value;

      if (!servico || !cliente || !data) {
        alert('Preencha todos os campos');
        return;
      }

      fetch(api, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ data_atendimento: data, servico: servico, cliente: cliente, status: status })

      })
      .then(res => {
        if (!res.ok) throw new Error('Erro ao adicionar');
        return res.json();
      })
      .then(() => {
        alert('Adicionado!');
        document.getElementById('servico').value = '';
        document.getElementById('cliente').value = '';
        document.getElementById('data').value = '';
        document.getElementById('status').value = 'Ativo';
        carregar();
      })
      .catch(err => alert(err.message));
    }

    function excluir(id) {
      if (!confirm('Confirma exclusão?')) return;

      fetch(`${api}/${id}`, {
        method: 'DELETE',
        headers: {
          'Authorization': 'Bearer ' + token
        }
      })
      .then(res => {
        if (!res.ok) throw new Error('Erro ao excluir');
        alert('Excluído!');
        carregar();
      })
      .catch(err => alert(err.message));
    }

    function editar(id, servico, cliente, data, status) {
      const novoServico = prompt('Serviço:', servico);
      const novoCliente = prompt('Cliente:', cliente);
      const novaData = prompt('Data (aaaa-mm-dd):', data);
      const novoStatus = prompt('Status (Ativo, Finalizado, Cancelado):', status);

      if (novoServico && novoCliente && novaData && novoStatus) {
        fetch(`${api}/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ data_atendimento: novaData, servico: novoServico, cliente: novoCliente, status: novoStatus })

        })
        .then(res => {
          if (!res.ok) throw new Error('Erro ao atualizar');
          alert('Atualizado!');
          carregar();
        })
        .catch(err => alert(err.message));
      }
    }

    carregar();
  </script>
</body>
</html>